# 阶段 2: 需求文档编写

**阶段目标**: 基于澄清后的需求，创建结构化、符合 EARS 语法的需求规格说明书

**预计时间**: 30-60 分钟

**参与角色**: 需求分析师

---

## 📋 本阶段概览

需求文档编写是将澄清后的需求转化为结构化、可验证、可测试的需求规格说明书的过程。

**关键原则**:
- **使用 EARS 语法**: 确保每个需求清晰、可测试
- **避免模糊词汇**: 使用具体的量化指标
- **考虑边界场景**: 不仅考虑正常流程，还要考虑异常和边界情况
- **独立验收标准**: 每个需求至少 2-5 个验收标准

---

## 🎯 准出标准 (本阶段完成的标志)

完成以下所有检查项才能进入阶段3：

- [ ] **EARS 语法**: 100% 的需求符合 EARS 语法规范
- [ ] **验收标准**: 每个功能需求至少 2 个验收标准
- [ ] **无模糊词汇**: 不包含"快速"、"适当"、"尽可能"等模糊词
- [ ] **量化指标**: 所有性能、时间相关需求有具体数值
- [ ] **需求分类**: 所有需求已分类（FR、NFR）和优先级（MoSCoW）
- [ ] **术语一致**: 使用术语表中定义的术语，无不一致
- [ ] **边界场景**: 考虑了输入边界、异常处理、并发场景
- [ ] **初步质量**: 质量评分 >= 70 分（合格）

---

## 📖 EARS 语法详解

EARS (Easy Approach to Requirements Syntax) 是一种结构化需求编写方法，确保需求清晰、可测试。

### EARS 语法模式

**1. 无条件需求 (Ubiquitous)**

```
THE System SHALL [系统行为]
```

**示例**:
```
THE System SHALL 使用 HTTPS 加密所有网络通信
THE System SHALL 记录所有错误信息到日志系统
THE System SHALL 支持 Chrome、Firefox、Safari 最新两个版本
```

**何时使用**: 系统必须始终遵守的行为，无条件、无触发。

---

**2. 事件驱动需求 (Event-driven)**

```
WHEN [触发事件] THEN THE System SHALL [系统响应]
```

**示例**:
```
WHEN 用户点击"提交"按钮 THEN THE System SHALL 验证表单数据并保存
WHEN 系统启动 THEN THE System SHALL 加载配置文件
WHEN 数据库连接失败 THEN THE System SHALL 记录错误并重试 3 次
```

**何时使用**: 由明确的事件触发的系统行为。

---

**3. 条件需求 (State-driven)**

```
WHILE [状态条件] THE System SHALL [系统行为]
```

**示例**:
```
WHILE 用户未登录 THE System SHALL 显示登录按钮
WHILE 数据加载中 THE System SHALL 显示加载动画
```

**何时使用**: 在某个状态持续期间，系统应该保持的行为。

---

**4. 可选功能需求 (Optional)**

```
WHERE [可选特性] THE System SHALL [系统行为]
```

**示例**:
```
WHERE 用户启用了深色模式 THE System SHALL 使用深色配色方案
WHERE 管理员权限存在 THE System SHALL 显示管理面板入口
```

**何时使用**: 只在特定配置或权限下才有的功能。

---

**5. 复杂条件需求 (Complex)**

```
IF [条件] THEN THE System SHALL [系统响应]
```

**示例**:
```
IF 密码长度小于 8 位 THEN THE System SHALL 拒绝注册并提示"密码至少 8 位"
IF 用户连续 3 次登录失败 THEN THE System SHALL 锁定账户 15 分钟
IF 文件大小超过 10MB THEN THE System SHALL 拒绝上传并提示"文件不能超过 10MB"
```

**何时使用**: 基于条件判断的系统行为。

---

### EARS 语法最佳实践

**✅ 推荐**:
```
WHEN 用户提交评论 THEN THE System SHALL 在 1 秒内保存并返回成功响应
```

**❌ 避免**:
```
评论应该快速保存  // 模糊、无主语、无条件
系统要保存评论    // 缺少触发条件
```

---

**✅ 推荐**:
```
IF 评论内容超过 500 字符 THEN THE System SHALL 拒绝提交并提示"评论不能超过 500 字符"
```

**❌ 避免**:
```
评论不能太长      // 模糊、无量化
系统应该限制评论长度  // 没说具体限制多少
```

---

## 📄 需求文档模板

### 完整结构

```markdown
# [项目名称] - 需求规格说明书

**文档版本**: v1.0.0
**创建日期**: YYYY-MM-DD
**最后更新**: YYYY-MM-DD
**状态**: 草稿 / 审核中 / 已批准

---

## 1. 引言

### 1.1 项目概述
[简要描述项目背景、目标和范围]

### 1.2 文档目的
本文档定义了 [项目名称] 的功能和非功能需求，作为设计、开发和测试的基准。

### 1.3 读者对象
- 产品经理
- 开发团队
- 测试团队
- 项目干系人

### 1.4 参考资料
- [原始需求文档路径]
- [相关技术文档]

---

## 2. 术语表

| 术语 | 定义 | 备注 |
|-----|------|-----|
| [术语1] | [明确的定义] | [补充说明] |
| [术语2] | [明确的定义] | [补充说明] |

---

## 3. 用户角色

| 角色ID | 角色名称 | 职责描述 | 权限级别 |
|-------|---------|---------|---------|
| ROLE-001 | [角色名] | [职责] | [权限] |

---

## 4. 功能需求

### 4.1 用户故事 1: [故事标题]

**需求ID**: REQ-FR-001
**优先级**: [MUST] / [SHOULD] / [COULD] / [WONT]
**相关角色**: ROLE-001

**用户故事**:
> 作为 [角色]，我想要 [功能]，以便 [业务价值]。

**验收标准**:
1. WHEN [触发条件] THEN THE System SHALL [系统响应]
2. IF [条件] THEN THE System SHALL [行为]
3. THE System SHALL [无条件行为]

**补充说明**:
- [任何需要额外说明的内容]

---

### 4.2 用户故事 2: [故事标题]
...

---

## 5. 非功能需求

### 5.1 性能需求
**REQ-NFR-PERF-001**: THE System SHALL 在 [X] 秒内响应 [Y]% 的用户请求

### 5.2 安全需求
**REQ-NFR-SEC-001**: THE System SHALL 使用 HTTPS 加密所有网络通信

### 5.3 可用性需求
**REQ-NFR-AVAIL-001**: THE System SHALL 达到 99.9% 的月度可用性

### 5.4 可维护性需求
**REQ-NFR-MAINT-001**: THE System SHALL 记录所有错误信息到日志系统

### 5.5 兼容性需求
**REQ-NFR-COMPAT-001**: THE System SHALL 支持 Chrome、Firefox、Safari 最新两个版本

---

## 6. 约束条件

### 6.1 技术约束
- [技术栈限制]

### 6.2 业务约束
- [业务规则限制]

### 6.3 法规约束
- [合规要求]

---

## 7. 假设与依赖

### 7.1 假设
- [假设条件 1]
- [假设条件 2]

### 7.2 外部依赖
- [依赖的外部系统/服务]

---

## 8. 风险识别

| 风险ID | 风险描述 | 影响程度 | 应对策略 |
|-------|---------|---------|---------|
| RISK-001 | [风险] | 高/中/低 | [应对措施] |

---

## 9. 需求追溯矩阵

| 需求ID | 原始需求来源 | 设计文档 | 测试用例 |
|-------|------------|---------|---------|
| REQ-FR-001 | [来源章节] | [TBD] | [TBD] |

---

## 10. 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|-----|------|---------|------|
| v1.0.0 | YYYY-MM-DD | 初始版本 | [姓名] |
```

---

## 🏷️ 需求分类体系

### 功能性需求 (FR)

**需求 ID 格式**: `REQ-FR-001`, `REQ-FR-002`...

**定义**: 描述系统"做什么"，即系统应该提供的功能和行为。

**示例**:
```
REQ-FR-001: WHEN 用户点击"注册"按钮 THEN THE System SHALL 验证输入并创建新用户账户
REQ-FR-002: THE System SHALL 允许用户搜索商品，通过名称、分类或标签
```

---

### 非功能性需求 (NFR)

#### 性能需求 (PERF)

**需求 ID 格式**: `REQ-NFR-PERF-001`

**示例**:
```
REQ-NFR-PERF-001: THE System SHALL 在 2 秒内响应 95% 的用户请求
REQ-NFR-PERF-002: THE System SHALL 支持至少 10,000 个并发用户
REQ-NFR-PERF-003: THE System SHALL 在数据库中存储至少 1000 万条记录而不降低性能
```

---

#### 安全需求 (SEC)

**需求 ID 格式**: `REQ-NFR-SEC-001`

**示例**:
```
REQ-NFR-SEC-001: THE System SHALL 使用 bcrypt 算法加密存储用户密码
REQ-NFR-SEC-002: THE System SHALL 记录所有敏感操作到审计日志
REQ-NFR-SEC-003: IF 用户连续 3 次登录失败 THEN THE System SHALL 锁定账户 15 分钟
REQ-NFR-SEC-004: THE System SHALL 使用 HTTPS 加密所有网络通信
```

---

#### 可用性需求 (AVAIL)

**需求 ID 格式**: `REQ-NFR-AVAIL-001`

**示例**:
```
REQ-NFR-AVAIL-001: THE System SHALL 达到 99.9% 的月度可用性（最多 43.2 分钟停机）
REQ-NFR-AVAIL-002: WHEN 系统故障 THEN THE System SHALL 在 5 分钟内自动恢复
REQ-NFR-AVAIL-003: THE System SHALL 提供健康检查端点供监控系统使用
```

---

#### 可维护性需求 (MAINT)

**需求 ID 格式**: `REQ-NFR-MAINT-001`

**示例**:
```
REQ-NFR-MAINT-001: THE System SHALL 使用结构化日志，包含请求 ID、用户 ID、时间戳
REQ-NFR-MAINT-002: THE System SHALL 提供 Prometheus 格式的监控指标
REQ-NFR-MAINT-003: THE System SHALL 支持在不停机的情况下更新配置
```

---

#### 兼容性需求 (COMPAT)

**需求 ID 格式**: `REQ-NFR-COMPAT-001`

**示例**:
```
REQ-NFR-COMPAT-001: THE System SHALL 支持 Chrome、Firefox、Safari、Edge 最新两个版本
REQ-NFR-COMPAT-002: THE System SHALL 适配移动端屏幕（最小宽度 320px）
REQ-NFR-COMPAT-003: THE System SHALL 与现有的 SSO 系统集成
```

---

## 🎯 优先级管理：MoSCoW 方法

### Must Have (必须有)

**定义**: 核心功能，没有这些需求，系统无法交付或失去基本价值。

**标识**: `[MUST]`

**判断标准**: "如果没有这个需求，系统能否发布？" → 答案是"不能"

**示例**:
```
[MUST] REQ-FR-001: 用户注册和登录功能
[MUST] REQ-FR-015: 支付功能（对于电商系统）
[MUST] REQ-NFR-SEC-001: 密码加密存储
```

---

### Should Have (应该有)

**定义**: 重要但不紧急，可以在后续版本中实现。

**标识**: `[SHOULD]`

**判断标准**: "如果时间不够，能否推迟到下个版本？" → 答案是"可以，但会有明显影响"

**示例**:
```
[SHOULD] REQ-FR-025: 用户头像上传功能
[SHOULD] REQ-FR-030: 搜索历史记录
[SHOULD] REQ-NFR-UX-002: 国际化支持
```

---

### Could Have (可以有)

**定义**: 有则更好，但不影响核心价值。

**标识**: `[COULD]`

**判断标准**: "如果完全不做，用户会抱怨吗？" → 答案是"可能不会"

**示例**:
```
[COULD] REQ-FR-040: 深色模式
[COULD] REQ-FR-042: 键盘快捷键
[COULD] REQ-NFR-UX-005: 动画过渡效果
```

---

### Won't Have (不会有)

**定义**: 明确当前版本不做，避免范围蔓延。

**标识**: `[WONT]` + 原因

**示例**:
```
[WONT] REQ-FR-050: 视频通话功能 | 原因：技术复杂度高，不符合当前阶段目标
[WONT] REQ-NFR-COMPAT-005: 支持 IE 11 | 原因：浏览器已停止支持，投入产出比低
```

---

## 🛡️ 边界场景和异常处理检查清单

对于每个功能需求，必须考虑以下边界场景：

### 1. 输入边界检查

#### 数值类型
- [ ] 最小值、最大值（包括边界值）
- [ ] 零值、负数、小数
- [ ] 超出范围的值（溢出）

**需求示例**:
```
IF 用户输入的年龄小于 0 或大于 150 THEN THE System SHALL 拒绝并提示"年龄必须在 0-150 之间"
```

#### 字符串类型
- [ ] 空字符串（""）
- [ ] null、undefined
- [ ] 只包含空格的字符串
- [ ] 超长字符串
- [ ] 特殊字符（<, >, &, ", ', \, /）
- [ ] SQL 注入、XSS 攻击字符

**需求示例**:
```
IF 用户输入的用户名长度超过 50 个字符 THEN THE System SHALL 拒绝并提示"用户名不能超过 50 字符"
IF 用户输入包含特殊字符 <, >, ", ' THEN THE System SHALL 转义这些字符以防止 XSS 攻击
```

#### 文件上传
- [ ] 空文件
- [ ] 超大文件
- [ ] 不支持的文件格式
- [ ] 损坏的文件

**需求示例**:
```
WHEN 用户上传文件大小超过 10MB THEN THE System SHALL 拒绝上传并提示"文件大小不能超过 10MB"
IF 文件格式不是 JPG、PNG THEN THE System SHALL 拒绝上传并提示"只支持 JPG 和 PNG 格式"
```

---

### 2. 并发和竞态条件

- [ ] 多用户同时编辑同一资源
- [ ] 多用户同时创建相同的唯一资源
- [ ] 资源锁定和释放机制

**需求示例**:
```
WHEN 两个用户同时编辑同一文档 THEN THE System SHALL 使用乐观锁机制，后保存的用户收到冲突提示
WHEN 用户 A 正在编辑资源 R THEN THE System SHALL 阻止用户 B 同时编辑资源 R
```

---

### 3. 网络和通信异常

- [ ] 请求超时
- [ ] 网络完全断开
- [ ] 服务器返回错误状态码（4xx, 5xx）
- [ ] 重试机制

**需求示例**:
```
IF API 请求在 30 秒内未收到响应 THEN THE System SHALL 超时并提示"网络请求超时，请稍后重试"
WHEN 网络请求失败 THEN THE System SHALL 自动重试最多 3 次，使用指数退避策略（1s, 2s, 4s）
```

---

### 4. 权限和安全边界

- [ ] 未登录用户访问受保护资源
- [ ] 已登录但权限不足
- [ ] Token/Session 过期
- [ ] 越权访问

**需求示例**:
```
IF 用户未登录 THEN THE System SHALL 重定向到登录页面
IF 用户尝试访问不属于自己的资源 THEN THE System SHALL 返回 403 Forbidden 错误
WHEN 用户的 Session 超过 30 分钟无活动 THEN THE System SHALL 自动登出并清除 Session
```

---

### 5. 数据和系统异常

- [ ] 数据库连接失败
- [ ] 数据库查询超时
- [ ] 事务回滚
- [ ] 唯一性约束违反

**需求示例**:
```
IF 数据库连接失败 THEN THE System SHALL 记录错误日志并返回 503 Service Unavailable
WHEN 数据库事务失败 THEN THE System SHALL 回滚所有操作并保持数据一致性
IF 唯一性约束违反（如邮箱已存在）THEN THE System SHALL 返回友好错误"该邮箱已被注册"
```

---

## 🤖 与大模型协作

### 生成需求文档的提示词

```
我正在进行需求分析的【阶段2：需求文档编写】。

请参考附件的最佳实践文档和模板，创建结构化的需求规格说明书，包括：
1. 引言和术语表
2. 用户角色
3. 功能需求（使用 EARS 语法，包含需求 ID、优先级、验收标准）
4. 非功能需求
5. 约束条件和依赖

要求：
- 所有需求必须符合 EARS 语法（THE、SHALL、WHEN、THEN、IF等）
- 避免模糊词汇（快速、适当、尽可能等）
- 使用具体的量化指标
- 考虑边界场景和异常处理
- 每个需求至少 2-3 个验收标准

澄清后的需求：
[粘贴阶段1输出的澄清需求]
```

---

## 📊 阶段完成检查清单

### 文档结构

- [ ] 已创建完整的文档结构（10个章节）
- [ ] 引言部分完整（概述、目的、读者对象、参考资料）
- [ ] 术语表包含所有关键术语
- [ ] 用户角色定义完整（ID、名称、职责、权限）

### 功能需求

- [ ] 所有功能需求使用用户故事格式
- [ ] 每个需求有唯一的需求 ID（REQ-FR-XXX）
- [ ] 每个需求有优先级标识（MUST/SHOULD/COULD/WONT）
- [ ] 每个需求有相关角色标注
- [ ] 每个需求至少 2 个验收标准
- [ ] 所有验收标准使用 EARS 语法

### 非功能需求

- [ ] 性能需求有具体数值（秒、百分比、并发数）
- [ ] 安全需求明确（加密、认证、授权、审计）
- [ ] 可用性需求量化（百分比、恢复时间）
- [ ] 可维护性需求明确（日志、监控）
- [ ] 兼容性需求具体（浏览器、设备、版本）

### 质量标准

- [ ] 100% 需求符合 EARS 语法
- [ ] 0% 模糊词汇（快速、适当、尽可能）
- [ ] 所有性能相关需求有量化指标
- [ ] 考虑了输入边界场景
- [ ] 考虑了异常处理和错误场景
- [ ] 考虑了并发和竞态条件
- [ ] 考虑了权限和安全边界

### 一致性

- [ ] 术语使用一致（与术语表一致）
- [ ] 需求 ID 唯一且连续
- [ ] 优先级合理（MUST < 30%）
- [ ] 无需求冲突

---

## 🎓 案例参考：博客评论系统（续）

### 生成的需求文档片段

```markdown
## 4. 功能需求

### 4.1 用户故事 1：发表评论

**需求ID**: REQ-FR-001
**优先级**: [MUST]
**相关角色**: ROLE-002（登录用户）

**用户故事**:
> 作为登录用户，我想要对文章发表评论，以便表达我的观点。

**验收标准**:
1. WHEN 登录用户在文章页面输入评论内容并点击"发表"按钮 THEN THE System SHALL 保存评论并显示在评论列表中
2. IF 评论内容长度超过 500 字符 THEN THE System SHALL 拒绝提交并提示"评论不能超过 500 字符"
3. IF 评论内容为空或只包含空格 THEN THE System SHALL 拒绝提交并提示"评论内容不能为空"
4. WHEN 评论成功发表 THEN THE System SHALL 在 1 秒内返回成功响应并刷新评论列表
5. THE System SHALL 记录评论的发表时间和作者信息（用户名、用户ID）
6. THE System SHALL 支持 Unicode 字符和 Emoji，计入字符总数

---

### 4.2 用户故事 2：回复评论

**需求ID**: REQ-FR-002
**优先级**: [MUST]
**相关角色**: ROLE-002（登录用户）

**用户故事**:
> 作为登录用户，我想要回复他人的评论，以便进行讨论。

**验收标准**:
1. WHEN 登录用户点击某条评论的"回复"按钮并输入内容 THEN THE System SHALL 将该回复关联到原评论（作为子评论）
2. THE System SHALL 支持最多 2 层嵌套（评论 → 回复 → 回复）
3. IF 用户尝试在第 2 层回复下继续回复 THEN THE System SHALL 禁用回复按钮
4. WHEN 回复成功发表 THEN THE System SHALL 在原评论下方显示该回复，缩进显示层级关系

---

## 5. 非功能需求

### 5.1 性能需求

**REQ-NFR-PERF-001**: THE System SHALL 在 2 秒内加载并显示评论列表（针对 95% 的请求）

**REQ-NFR-PERF-002**: THE System SHALL 在 1 秒内完成评论提交并返回响应（针对 95% 的请求）

### 5.2 安全需求

**REQ-NFR-SEC-001**: THE System SHALL 转义所有用户输入的特殊字符（<, >, ", ', &）以防止 XSS 攻击

**REQ-NFR-SEC-002**: IF 用户在 1 分钟内提交评论超过 5 次 THEN THE System SHALL 拒绝后续请求并提示"操作过于频繁，请稍后再试"
```

---

## ⏭️ 下一步

完成本阶段所有检查项后，进入：

**阶段 3: 需求验证**
- 文档: `.kiro/steering/requirements/phase3-verification.md`
- 对需求文档进行多维度验证，确保质量达到优秀水平

---

**记住**: 需求文档是设计和开发的基准。花时间编写高质量的需求文档，可以避免后续大量返工。
