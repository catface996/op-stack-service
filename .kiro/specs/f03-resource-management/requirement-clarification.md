# 需求澄清文档

**功能名称**: F03 - 创建和管理IT资源  
**创建日期**: 2024-11-30  
**需求分析师**: AI Assistant  
**状态**: 已澄清 ✅

---

## 1. 需求概述

### 1.1 核心需求（3-5句话）

F03 功能旨在提供统一的IT资源管理能力，**MVP阶段**支持6种预置资源类型（基础设施、应用、数据库、接口、中间件、报表）的全生命周期管理（创建、查看、编辑、删除），并与权限系统集成。**关键架构决策**：数据模型采用"架构前瞻"设计，通过 `resource_type` 表管理类型，扩展属性使用JSON存储，为未来的F02-1（动态资源类型管理）预留扩展性，确保零重构成本。系统支持按名称搜索、按类型和标签过滤，使用乐观锁处理并发编辑冲突，敏感信息（账号密码）采用AES-256加密存储。

### 1.2 业务目标

**Why - 为什么需要这个功能？**

- **业务价值**：提供统一的IT资源管理入口，降低运维复杂度，提升资源可见性
- **解决的痛点**：
  - 资源分散在多个系统，缺乏统一视图
  - 资源信息维护困难，更新不及时
  - 缺乏权限控制，资源管理混乱
- **期望的效果**：
  - 所有IT资源在一个平台统一管理
  - 支持至少10000个资源的高效管理
  - 资源列表查询响应时间 < 1秒

### 1.3 用户角色

**Who - 谁使用这个功能？**

| 角色 | 职责 | 使用场景 | 权限要求 |
|------|------|---------|---------|
| 运维工程师 | 创建和维护IT资源 | 日常资源管理、信息更新 | Owner（创建者自动成为Owner） |
| 系统管理员 | 管理所有资源 | 资源审计、批量操作 | 超级管理员 |
| 开发人员 | 查看资源信息 | 了解依赖的资源配置 | Viewer |
| 架构师 | 查看资源拓扑 | 架构梳理、影响分析 | Viewer |

---

## 2. 需求澄清结果

### 2.1 功能范围澄清

**What - 具体要做什么？**

| 功能点 | 原始描述 | 澄清后的精确描述 | 优先级 |
|-------|---------|----------------|--------|
| 创建资源 | 选择资源类型并填写信息 | 从6种预置类型中选择，填写基本信息（名称、描述、标签）和扩展属性（JSON格式），创建者自动成为Owner | Must |
| 查看资源列表 | 展示所有资源 | 分页展示资源列表（默认20条/页），支持按名称搜索（模糊匹配），按类型和标签过滤，按创建时间/更新时间/名称排序 | Must |
| 编辑资源信息 | 更新资源信息 | Owner可编辑所有字段（名称、描述、标签、扩展属性、状态），使用乐观锁防止并发冲突，敏感信息加密存储 | Must |
| 删除资源 | 删除资源 | 检查关联关系（拓扑、Agent、任务），提示确认后强制删除，记录审计日志，只有Owner可删除 | Must |
| 查看资源详情 | 展示完整信息 | 展示所有字段，包括基本信息、扩展属性、状态、权限信息、创建/更新时间、操作历史 | Must |
| 资源状态管理 | 显示资源状态 | 支持4种状态（运行中、已停止、维护中、已下线），手动设置，状态变更记录审计日志 | Must |

### 2.2 触发条件和时机

**When - 什么时候触发？**

| 功能 | 触发条件 | 触发时机 | 频率 |
|------|---------|---------|------|
| 创建资源 | 用户点击"创建资源"按钮 | 需要添加新资源时 | 按需 |
| 查看列表 | 用户访问资源管理页面 | 进入资源管理模块 | 高频（每天多次） |
| 搜索过滤 | 用户输入搜索关键词或选择过滤条件 | 需要查找特定资源时 | 高频 |
| 编辑资源 | Owner点击"编辑"按钮 | 资源信息变更时 | 中频（每周数次） |
| 删除资源 | Owner点击"删除"按钮并确认 | 资源下线或清理时 | 低频（每月数次） |
| 状态变更 | Owner手动修改状态 | 资源状态发生变化时 | 中频 |

### 2.3 使用环境和场景

**Where - 在哪里使用？**

- **使用环境**：Web浏览器（Chrome、Safari、Firefox、Edge）
- **设备要求**：PC端（推荐分辨率 ≥ 1366x768）
- **网络要求**：内网或VPN连接
- **浏览器要求**：支持ES6+、WebSocket（未来拓扑实时更新）

### 2.4 实现方式和验收标准

**How - 如何实现？如何验证？**

#### 功能1：创建资源

**实现要点**：
- 两步创建流程：选择类型 → 填写信息
- 表单验证：名称必填（2-100字符）、描述可选（最多500字符）
- 扩展属性根据资源类型动态渲染（JSON Schema驱动）
- 敏感字段（包含"password"、"secret"、"key"关键词）自动加密

**验收标准**：
- [ ] 用户可以从6种预置类型中选择
- [ ] 填写必填字段后可以成功创建资源
- [ ] 创建者自动成为资源的第一个Owner
- [ ] 敏感信息在数据库中以加密形式存储（AES-256）
- [ ] 创建成功后跳转到资源详情页

#### 功能2：查看资源列表

**实现要点**：
- 分页加载（默认20条/页，支持10/20/50/100）
- 搜索：只搜索资源名称，支持模糊匹配（LIKE %keyword%）
- 过滤：类型下拉框、标签多选框
- 排序：创建时间（默认降序）、更新时间、名称（字母序）

**验收标准**：
- [ ] 列表展示资源名称、类型、状态、标签、创建时间、更新时间
- [ ] 搜索框输入关键词后实时过滤（防抖300ms）
- [ ] 类型过滤器只显示选中类型的资源
- [ ] 标签过滤器支持多选（AND逻辑）
- [ ] 排序功能正常工作
- [ ] 列表查询响应时间 < 1秒（10000资源场景）

#### 功能3：编辑资源信息

**实现要点**：
- 权限检查：只有Owner可以编辑
- 乐观锁：使用version字段，更新时检查版本号
- 并发冲突处理：提示用户"资源已被他人修改，请刷新后重试"
- 敏感信息编辑：显示为***，修改时重新加密

**验收标准**：
- [ ] Owner可以编辑所有字段
- [ ] 非Owner无法看到编辑按钮
- [ ] 并发编辑时，后提交的用户收到冲突提示
- [ ] 敏感信息修改后重新加密存储
- [ ] 编辑成功后更新 updated_at 和 version

#### 功能4：删除资源

**实现要点**：
- 权限检查：只有Owner可以删除
- 关联检查：查询拓扑关系、Agent关联、任务关联
- 二次确认：弹窗提示关联信息，要求用户输入资源名称确认
- 强制删除：用户确认后物理删除（DELETE）
- 审计日志：记录删除操作（操作人、时间、资源信息）

**验收标准**：
- [ ] 非Owner无法看到删除按钮
- [ ] 删除前检查关联关系并提示
- [ ] 用户必须输入资源名称才能确认删除
- [ ] 删除成功后记录审计日志
- [ ] 删除后资源从列表中消失

#### 功能5：查看资源详情

**实现要点**：
- Tab页布局：概览、配置、拓扑（F04）、Agent（F06）、任务、权限
- 概览Tab：展示所有基本信息和扩展属性
- 敏感信息：Owner可见（点击显示），Viewer不可见
- 操作历史：展示最近10条操作记录

**验收标准**：
- [ ] 详情页展示所有字段
- [ ] 敏感信息根据权限控制可见性
- [ ] 状态以徽章形式展示（运行中-绿色、已停止-灰色、维护中-黄色、已下线-红色）
- [ ] 权限信息展示Owner和Viewer列表
- [ ] 操作历史按时间倒序展示

#### 功能6：资源状态管理

**实现要点**：
- 4种状态：运行中（RUNNING）、已停止（STOPPED）、维护中（MAINTENANCE）、已下线（OFFLINE）
- 手动设置：Owner在详情页或列表页快速切换
- 状态变更记录：审计日志记录状态变更（旧状态 → 新状态）

**验收标准**：
- [ ] 支持4种预定义状态
- [ ] Owner可以手动切换状态
- [ ] 状态变更记录到审计日志
- [ ] 列表页状态以徽章形式展示

### 2.5 性能和质量指标

**How Much - 具体指标是多少？**

| 指标类型 | 指标名称 | 目标值 | 测量方法 |
|---------|---------|--------|---------|
| 性能 | 列表查询响应时间 | < 1秒 | 10000资源场景，后端处理时间 |
| 性能 | 搜索响应时间 | < 500ms | 包含网络传输时间 |
| 性能 | 详情页加载时间 | < 500ms | 包含网络传输时间 |
| 性能 | 创建资源响应时间 | < 200ms | 后端处理时间 |
| 容量 | 支持资源数量 | ≥ 10000 | 压力测试验证 |
| 容量 | 并发用户数 | ≥ 100 | 并发测试验证 |
| 质量 | 系统可用性 | ≥ 99.9% | 月度统计 |
| 质量 | 数据准确性 | 100% | 乐观锁保证 |
| 安全 | 敏感信息加密率 | 100% | 代码审查 |

---

## 3. 模糊点澄清记录

### 3.1 已澄清的模糊点

| ID | 模糊表述 | 提出的问题 | 澄清结果 | 影响范围 |
|----|---------|-----------|---------|---------|
| CL-001 | "资源状态" | 有哪些状态？如何设置？ | 4种状态（运行中、已停止、维护中、已下线），手动设置 | 数据模型、UI设计 |
| CL-002 | "敏感信息加密" | 哪些字段？用什么算法？ | 账号密码字段，AES-256，数据库存储 | 安全设计、数据模型 |
| CL-003 | "删除资源" | 有关联时如何处理？ | 提示确认后强制删除 | 删除逻辑、用户体验 |
| CL-004 | "权限系统集成" | F11的状态？ | 后续开发，当前不需要Mock | 开发顺序、接口设计 |
| CL-005 | "搜索功能" | 搜索哪些字段？ | 只搜索名称，模糊匹配 | 搜索实现、性能优化 |
| CL-006 | "标签管理" | 预定义还是自定义？ | 用户可自定义标签 | 数据模型、UI设计 |
| CL-007 | "并发编辑" | 如何处理冲突？ | 使用乐观锁（version字段） | 数据模型、并发控制 |

### 3.2 识别并消除的歧义

| ID | 歧义表述 | 可能的理解A | 可能的理解B | 最终确认 |
|----|---------|-----------|-----------|---------|
| AM-001 | "资源类型扩展表" | 为每种类型建独立表 | 使用JSON存储扩展属性 | 使用JSON存储，为F02-1预留扩展性 |
| AM-002 | "实时过滤" | 前端过滤（客户端） | 后端搜索（服务端） | 后端搜索，支持大数据量 |
| AM-003 | "删除资源" | 软删除（标记） | 物理删除（DELETE） | 物理删除，提示确认后强制删除 |

---

## 4. 关键假设

| ID | 假设内容 | 依据 | 验证方法 | 验证时间 | 状态 |
|----|---------|------|---------|---------|------|
| AS-001 | MVP阶段使用6种预置资源类型 | 用户确认 | 已确认 | - | ✅ 已验证 |
| AS-002 | 数据模型预留扩展性，支持F02-1 | 架构决策 | 已确认 | - | ✅ 已验证 |
| AS-003 | 扩展属性使用JSON存储 | 技术方案 | 已确认 | - | ✅ 已验证 |
| AS-004 | 权限系统（F11）后续开发 | 用户确认 | 已确认 | - | ✅ 已验证 |
| AS-005 | 搜索只支持名称字段 | 用户确认，性能考虑 | 已确认 | - | ✅ 已验证 |
| AS-006 | 标签数量限制为10个/资源 | 行业最佳实践 | 用户测试 | 开发阶段 | 待验证 |
| AS-007 | 列表默认分页20条 | 行业最佳实践 | 用户测试 | 开发阶段 | 待验证 |
| AS-008 | 敏感字段通过关键词识别 | 技术实现 | 代码审查 | 开发阶段 | 待验证 |

**关键假设详细说明**：

1. **AS-006: 标签数量限制**
   - 内容：每个资源最多10个标签
   - 如果假设不成立的影响：UI展示混乱，查询性能下降
   - 缓解策略：如果用户反馈不够，可调整为20个

2. **AS-007: 列表分页大小**
   - 内容：默认20条/页，可选10/20/50/100
   - 如果假设不成立的影响：用户体验不佳
   - 缓解策略：根据用户反馈调整默认值

3. **AS-008: 敏感字段识别**
   - 内容：字段名包含"password"、"secret"、"key"等关键词自动加密
   - 如果假设不成立的影响：部分敏感信息未加密
   - 缓解策略：提供手动标记敏感字段的功能

---

## 5. 技术风险识别

| ID | 风险描述 | 概率 | 影响 | 风险等级 | 初步应对思路 |
|----|---------|------|------|---------|-------------|
| RISK-001 | 10000资源的列表查询性能无法满足<1秒要求 | 中 | 高 | 高 | 1. 数据库索引优化（name, type, created_at） 2. 分页查询 3. Redis缓存热点数据 |
| RISK-002 | JSON扩展属性查询性能差 | 中 | 中 | 中 | 1. 为常用属性建虚拟列索引 2. 限制JSON深度 3. 考虑使用PostgreSQL的JSONB |
| RISK-003 | AES-256加密性能影响 | 低 | 中 | 低 | 1. 只加密必要字段 2. 使用硬件加速 3. 异步加密（创建时） |
| RISK-004 | 乐观锁冲突频繁，用户体验差 | 低 | 中 | 低 | 1. 提供友好的冲突提示 2. 支持合并编辑 3. 监控冲突率 |
| RISK-005 | 敏感信息加密的密钥管理复杂 | 低 | 高 | 中 | 1. 密钥存储在配置文件（加密） 2. 未来迁移到AWS KMS 3. 定期轮换密钥 |

**高风险详细说明**：

1. **RISK-001: 列表查询性能**
   - 具体描述：10000资源场景下，列表查询可能超过1秒
   - 触发条件：资源数量 > 5000，并发用户 > 50
   - 影响范围：用户体验、系统可用性
   - 初步建议：
     - 数据库索引：`CREATE INDEX idx_resource_list ON resource(type, created_at DESC)`
     - 分页查询：使用游标分页而非OFFSET
     - 缓存策略：Redis缓存前3页数据（TTL 5分钟）
     - 监控告警：查询时间 > 800ms 触发告警

---

## 6. 边界和约束

### 6.1 功能边界（不包含什么）

- ❌ 资源类型的动态管理（属于F02-1）
- ❌ 资源拓扑关系管理（属于F04）
- ❌ Agent关联和任务管理（属于F06）
- ❌ 资源监控和告警（属于后续Feature）
- ❌ 资源自动发现（属于后续Feature）
- ❌ 批量导入导出（属于后续Feature）

### 6.2 技术约束

- 使用MySQL 8.0+（项目标准）
- 使用MyBatis-Plus 3.5.7（项目标准）
- 使用Spring Boot 3.4.1（项目标准）
- 遵循DDD分层架构（项目标准）
- JSON字段最大1MB（MySQL限制）

### 6.3 业务约束

- 资源名称在同一类型下必须唯一
- 删除资源需要Owner权限
- 敏感信息只有Owner可见
- 审计日志保留180天

### 6.4 时间约束

- MVP开发周期：2-3周
- 必须在F04（拓扑关系）之前完成
- 与F11（权限管理）可并行开发

---

## 7. 依赖关系

### 7.1 外部依赖

| 依赖项 | 类型 | 提供方 | 可用性 | 风险 |
|-------|------|--------|--------|------|
| MySQL 8.0 | 数据库 | 基础设施团队 | 已就绪 | 低 |
| Redis 7.0 | 缓存 | 基础设施团队 | 已就绪 | 低 |

### 7.2 内部依赖

| 依赖项 | 类型 | 负责团队 | 状态 | 依赖时间 |
|-------|------|---------|------|---------|
| F10: 用户认证 | 前置功能 | 认证团队 | 已完成 | 立即 |
| F11: 权限管理 | 并行功能 | 权限团队 | 开发中 | 后续集成 |

---

## 8. 架构前瞻设计（为F02-1预留）

### 8.1 数据模型设计

```sql
-- 资源类型表（MVP预置6种，F02-1开放管理）
CREATE TABLE resource_type (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) UNIQUE NOT NULL COMMENT '类型编码：SERVER, APPLICATION, DATABASE, API, MIDDLEWARE, REPORT',
    name VARCHAR(100) NOT NULL COMMENT '类型名称',
    description TEXT COMMENT '类型描述',
    icon VARCHAR(100) COMMENT '图标URL',
    is_system BOOLEAN DEFAULT TRUE COMMENT '是否系统预置',
    attribute_schema JSON COMMENT '属性定义Schema（为F02-1预留）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT,
    INDEX idx_code (code),
    INDEX idx_is_system (is_system)
) COMMENT='资源类型表';

-- 资源表
CREATE TABLE resource (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL COMMENT '资源名称',
    description TEXT COMMENT '资源描述',
    resource_type_id BIGINT NOT NULL COMMENT '资源类型ID',
    status VARCHAR(20) NOT NULL DEFAULT 'RUNNING' COMMENT '状态：RUNNING, STOPPED, MAINTENANCE, OFFLINE',
    attributes JSON COMMENT '扩展属性（JSON格式）',
    version INT DEFAULT 0 COMMENT '版本号（乐观锁）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT COMMENT '创建者（第一个Owner）',
    FOREIGN KEY (resource_type_id) REFERENCES resource_type(id),
    INDEX idx_name (name),
    INDEX idx_type (resource_type_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at DESC),
    INDEX idx_updated_at (updated_at DESC),
    UNIQUE KEY uk_type_name (resource_type_id, name)
) COMMENT='资源表';

-- 资源标签关联表
CREATE TABLE resource_tag (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL,
    tag_name VARCHAR(50) NOT NULL COMMENT '标签名称',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT,
    FOREIGN KEY (resource_id) REFERENCES resource(id) ON DELETE CASCADE,
    UNIQUE KEY uk_resource_tag (resource_id, tag_name),
    INDEX idx_tag_name (tag_name)
) COMMENT='资源标签关联表';

-- 审计日志表
CREATE TABLE resource_audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    resource_id BIGINT NOT NULL,
    operation VARCHAR(20) NOT NULL COMMENT '操作：CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON COMMENT '旧值',
    new_value JSON COMMENT '新值',
    operator_id BIGINT NOT NULL COMMENT '操作人',
    operator_name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (resource_id) REFERENCES resource(id) ON DELETE CASCADE,
    INDEX idx_resource_id (resource_id),
    INDEX idx_created_at (created_at DESC)
) COMMENT='资源审计日志表';
```

### 8.2 扩展性保证

**为F02-1预留的扩展点**：

1. **资源类型管理**：
   - `resource_type` 表已创建，MVP预置6种类型
   - `is_system` 字段区分系统预置和自定义类型
   - `attribute_schema` 字段预留属性定义（JSON Schema格式）

2. **属性验证**：
   - `attributes` 字段使用JSON存储，灵活扩展
   - 未来可根据 `attribute_schema` 动态验证

3. **UI动态渲染**：
   - 前端根据 `resource_type` 动态渲染表单
   - 属性字段根据 `attribute_schema` 生成

---

## 9. 下一步行动

- [x] 用户已确认本澄清文档
- [ ] 进入阶段2：需求文档编写
- [ ] 在阶段2中验证所有标记为"待验证"的假设
- [ ] 在阶段2中评估所有识别的技术风险

---

**审核签名**：
- 需求分析师：AI Assistant
- 用户确认：待确认 - 2024-11-30

**文档版本**: v1.0  
**最后更新**: 2024-11-30 15:30
