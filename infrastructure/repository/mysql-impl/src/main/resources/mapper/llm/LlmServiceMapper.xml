<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.llm.LlmServiceMapper">

    <!-- 结果映射 -->
    <resultMap id="LlmServiceResultMap" type="com.catface996.aiops.repository.mysql.po.llm.LlmServicePO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="providerType" column="provider_type"/>
        <result property="endpoint" column="endpoint"/>
        <result property="modelParameters" column="model_parameters"/>
        <result property="priority" column="priority"/>
        <result property="enabled" column="enabled"/>
        <result property="isDefault" column="is_default"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 根据名称查询 -->
    <select id="findByName" resultMap="LlmServiceResultMap">
        SELECT * FROM llm_service_config WHERE name = #{name}
    </select>

    <!-- 根据启用状态查询 -->
    <select id="findByEnabled" resultMap="LlmServiceResultMap">
        SELECT * FROM llm_service_config WHERE enabled = #{enabled} ORDER BY priority ASC
    </select>

    <!-- 查询所有并按优先级排序 -->
    <select id="findAllOrderByPriority" resultMap="LlmServiceResultMap">
        SELECT * FROM llm_service_config ORDER BY priority ASC
    </select>

    <!-- 清除所有默认标记 -->
    <update id="clearAllDefault">
        UPDATE llm_service_config SET is_default = FALSE WHERE is_default = TRUE
    </update>

    <!-- 设置指定服务为默认 -->
    <update id="setDefault">
        UPDATE llm_service_config SET is_default = TRUE WHERE id = #{id}
    </update>

    <!-- 统计启用且为默认的服务数量 -->
    <select id="countEnabledDefault" resultType="int">
        SELECT COUNT(*) FROM llm_service_config WHERE enabled = TRUE AND is_default = TRUE
    </select>

</mapper>
