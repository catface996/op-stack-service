<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.topology.TopologyReportTemplateMapper">

    <sql id="Base_Column_List">
        id, topology_id, report_template_id, created_by, created_at
    </sql>

    <!-- 根据拓扑图ID和报告模板ID查询关联记录 -->
    <select id="selectByTopologyIdAndTemplateId" resultType="com.catface996.aiops.repository.mysql.po.topology.TopologyReportTemplatePO">
        SELECT <include refid="Base_Column_List"/>
        FROM topology_2_report_template
        WHERE topology_id = #{topologyId} AND report_template_id = #{reportTemplateId}
    </select>

    <!-- 批量物理删除关联记录 -->
    <delete id="batchDelete">
        DELETE FROM topology_2_report_template
        WHERE topology_id = #{topologyId}
        AND report_template_id IN
        <foreach collection="reportTemplateIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 分页查询已绑定的报告模板（带模板详情） -->
    <select id="selectBoundTemplates" resultType="com.catface996.aiops.repository.mysql.po.topology.TopologyReportTemplatePO">
        SELECT trt.id, trt.topology_id, trt.report_template_id, trt.created_by, trt.created_at,
            rt.name AS template_name, rt.description AS template_description, rt.category AS template_category
        FROM topology_2_report_template trt
        INNER JOIN report_template rt ON trt.report_template_id = rt.id AND rt.deleted = 0
        WHERE trt.topology_id = #{topologyId}
        <if test="keyword != null and keyword != ''">
            AND (rt.name LIKE CONCAT('%', #{keyword}, '%') OR rt.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY trt.created_at DESC
    </select>

    <!-- 分页查询未绑定的报告模板 -->
    <select id="selectUnboundTemplates" resultType="com.catface996.aiops.repository.mysql.po.report.ReportTemplatePO">
        SELECT rt.*
        FROM report_template rt
        WHERE rt.deleted = 0
        AND rt.id NOT IN (
            SELECT report_template_id FROM topology_2_report_template
            WHERE topology_id = #{topologyId}
        )
        <if test="keyword != null and keyword != ''">
            AND (rt.name LIKE CONCAT('%', #{keyword}, '%') OR rt.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY rt.created_at DESC
    </select>

    <!-- 查询拓扑图已绑定的模板ID列表 -->
    <select id="selectBoundTemplateIds" resultType="java.lang.Long">
        SELECT report_template_id
        FROM topology_2_report_template
        WHERE topology_id = #{topologyId}
    </select>

    <!-- 统计拓扑图绑定的模板数量 -->
    <select id="countByTopologyId" resultType="int">
        SELECT COUNT(*)
        FROM topology_2_report_template
        WHERE topology_id = #{topologyId}
    </select>

</mapper>
