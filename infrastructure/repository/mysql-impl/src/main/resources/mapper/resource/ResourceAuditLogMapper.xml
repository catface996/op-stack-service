<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.resource.ResourceAuditLogMapper">

    <!-- 根据资源ID分页查询审计日志 -->
    <select id="selectByResourceId" resultType="com.catface996.aiops.repository.mysql.po.resource.ResourceAuditLogPO">
        SELECT id, resource_id, operation, operator_id, operator_name, old_value, new_value, remark, created_at
        FROM resource_audit_log
        WHERE resource_id = #{resourceId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计资源的审计日志数量 -->
    <select id="countByResourceId" resultType="long">
        SELECT COUNT(*)
        FROM resource_audit_log
        WHERE resource_id = #{resourceId}
    </select>

    <!-- 根据操作类型查询审计日志 -->
    <select id="selectByResourceIdAndOperation" resultType="com.catface996.aiops.repository.mysql.po.resource.ResourceAuditLogPO">
        SELECT id, resource_id, operation, operator_id, operator_name, old_value, new_value, remark, created_at
        FROM resource_audit_log
        WHERE resource_id = #{resourceId} AND operation = #{operation}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据时间范围查询审计日志 -->
    <select id="selectByResourceIdAndTimeRange" resultType="com.catface996.aiops.repository.mysql.po.resource.ResourceAuditLogPO">
        SELECT id, resource_id, operation, operator_id, operator_name, old_value, new_value, remark, created_at
        FROM resource_audit_log
        WHERE resource_id = #{resourceId}
        AND created_at BETWEEN #{startTime} AND #{endTime}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据操作人ID查询审计日志 -->
    <select id="selectByOperatorId" resultType="com.catface996.aiops.repository.mysql.po.resource.ResourceAuditLogPO">
        SELECT id, resource_id, operation, operator_id, operator_name, old_value, new_value, remark, created_at
        FROM resource_audit_log
        WHERE operator_id = #{operatorId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 删除资源的所有审计日志 -->
    <delete id="deleteByResourceId">
        DELETE FROM resource_audit_log
        WHERE resource_id = #{resourceId}
    </delete>

    <!-- 清理指定时间之前的审计日志 -->
    <delete id="deleteByCreatedAtBefore">
        DELETE FROM resource_audit_log
        WHERE created_at &lt; #{beforeTime}
    </delete>

</mapper>
