<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.report.ReportTemplateMapper">

    <sql id="Base_Column_List">
        id, name, description, category, content, tags, version, deleted,
        created_by, created_at, updated_by, updated_at
    </sql>

    <!-- 根据名称查询模板 -->
    <select id="selectByName" resultType="com.catface996.aiops.repository.mysql.po.report.ReportTemplatePO">
        SELECT <include refid="Base_Column_List"/>
        FROM report_template
        WHERE name = #{name} AND deleted = 0
    </select>

    <!-- 分页查询模板列表 -->
    <select id="selectPageByCondition" resultType="com.catface996.aiops.repository.mysql.po.report.ReportTemplatePO">
        SELECT <include refid="Base_Column_List"/>
        FROM report_template
        <where>
            deleted = 0
            <if test="category != null and category != ''">AND category = #{category}</if>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%') OR tags LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <!-- 按条件统计模板数量 -->
    <select id="countByCondition" resultType="long">
        SELECT COUNT(*)
        FROM report_template
        <where>
            deleted = 0
            <if test="category != null and category != ''">AND category = #{category}</if>
            <if test="keyword != null and keyword != ''">
                AND (name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%') OR tags LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 批量查询存在的模板ID -->
    <select id="selectExistingIds" resultType="java.lang.Long">
        SELECT id FROM report_template
        WHERE deleted = 0 AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 软删除报告模板 -->
    <update id="softDeleteById">
        UPDATE report_template
        SET deleted = 1, updated_at = #{updatedAt}
        WHERE id = #{id} AND deleted = 0
    </update>

</mapper>
